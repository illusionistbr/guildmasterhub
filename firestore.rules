
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is a member of the guild
    function isGuildMember(guildId) {
      return request.auth != null && request.auth.uid in get(/databases/$(database)/documents/guilds/$(guildId)).data.memberIds;
    }

    // Helper function to check if a user has a specific permission for a guild
    function hasGuildPermission(guildId, permissionName) {
      let guildData = get(/databases/$(database)/documents/guilds/$(guildId)).data;
      // Ensure customRoles, user's roleName, and its permissions list exist before trying to access
      return request.auth != null &&
             guildData.roles != null &&
             guildData.roles[request.auth.uid] != null &&
             guildData.roles[request.auth.uid].roleName != null &&
             guildData.customRoles != null &&
             guildData.customRoles[guildData.roles[request.auth.uid].roleName] != null &&
             guildData.customRoles[guildData.roles[request.auth.uid].roleName].permissions != null &&
             permissionName in guildData.customRoles[guildData.roles[request.auth.uid].roleName].permissions;
    }

    // Simplified check for owner or a user with a broad admin-like permission.
    function isGuildAdminEquivalent(guildId) {
      let guildData = get(/databases/$(database)/documents/guilds/$(guildId)).data;
      return request.auth != null &&
             (request.auth.uid == guildData.ownerId ||
              hasGuildPermission(guildId, "MANAGE_ROLES_PERMISSIONS")); // Example of a high-level permission
    }

    match /users/{userId} {
      allow read, update, create: if request.auth != null && request.auth.uid == userId;
    }

    match /guilds/{guildId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.ownerId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.ownerId;

      allow update: if request.auth != null && (
        // Condition 1: Guild Owner
        request.auth.uid == resource.data.ownerId ||

        // Condition 2: General Settings
        (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name', 'description', 'game', 'region', 'server', 'tags', 'password', 'isOpen', 'socialLinks', 'tlGuildFocus']) &&
          hasGuildPermission(guildId, "MANAGE_GUILD_SETTINGS_GENERAL")
        ) ||

        // Condition 3: Recruitment Questions
        (
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['recruitmentQuestions']) &&
            hasGuildPermission(guildId, "MANAGE_RECRUITMENT_PROCESS_APPLICATIONS")
        ) ||

        // Condition 4: Appearance
        (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['bannerUrl', 'logoUrl']) &&
          hasGuildPermission(guildId, "MANAGE_GUILD_SETTINGS_APPEARANCE")
        ) ||

        // Condition 5: DKP Settings
        (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['dkpSystemEnabled', 'dkpRedemptionWindow', 'dkpDefaultsPerCategory']) &&
          hasGuildPermission(guildId, "MANAGE_DKP_SETTINGS")
        ) ||

        // Condition 6: DKP Decay Settings
        (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['dkpDecayEnabled', 'dkpDecayPercentage', 'dkpDecayIntervalDays', 'dkpDecayInitialDate', 'lastDkpDecayTimestamp']) &&
          hasGuildPermission(guildId, "MANAGE_DKP_DECAY_SETTINGS")
        ) ||

        // Condition 7: Custom Roles / Permissions
        (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['customRoles']) &&
          hasGuildPermission(guildId, "MANAGE_ROLES_PERMISSIONS")
        ) ||

        // Condition 8: Adding a member
        (
          request.resource.data.memberCount == resource.data.memberCount + 1 &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberCount', 'memberIds', 'roles']) &&
          hasGuildPermission(guildId, "MANAGE_RECRUITMENT_PROCESS_APPLICATIONS")
        ) ||

        // Condition 9: Kicking a member
        (
          request.resource.data.memberCount == resource.data.memberCount - 1 &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberCount', 'memberIds', 'roles']) &&
          hasGuildPermission(guildId, "MANAGE_MEMBERS_KICK")
        ) ||

        // Condition 10: User updating their OWN profile within roles map
        (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['roles']) &&
          request.resource.data.roles.diff(resource.data.roles).affectedKeys().hasOnly([request.auth.uid]) &&
          request.resource.data.roles[request.auth.uid].diff(resource.data.roles[request.auth.uid]).affectedKeys().hasOnly([
            'characterNickname', 'gearScore', 'gearScoreScreenshotUrl', 'gearBuildLink', 'skillBuildLink', 'tlRole', 'tlPrimaryWeapon', 'tlSecondaryWeapon'
          ])
        ) ||
        
        // Condition 11: Admin updating OTHER member's profile (role, status, notes, dkp)
        (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['roles']) &&
          (
            hasGuildPermission(guildId, "MANAGE_MEMBERS_EDIT_ROLE") ||
            hasGuildPermission(guildId, "MANAGE_MEMBERS_EDIT_STATUS") ||
            hasGuildPermission(guildId, "MANAGE_MEMBERS_EDIT_NOTES") ||
            hasGuildPermission(guildId, "MANAGE_MEMBER_DKP_BALANCE")
          )
        )
      );

      // --- Subcollections ---

      match /auditLogs/{logId} {
        allow read: if hasGuildPermission(guildId, "VIEW_AUDIT_LOG");
        allow create: if isGuildAdminEquivalent(guildId);
        allow delete: if request.auth.uid == get(/databases/$(database)/documents/guilds/$(guildId)).data.ownerId;
      }

      match /applications/{applicationId} {
        allow read: if hasGuildPermission(guildId, "MANAGE_RECRUITMENT_VIEW_APPLICATIONS") || request.auth.uid == resource.data.applicantId;
        allow create: if request.auth.uid == request.resource.data.applicantId;
        allow update: if hasGuildPermission(guildId, "MANAGE_RECRUITMENT_PROCESS_APPLICATIONS");
        allow delete: if request.auth.uid == get(/databases/$(database)/documents/guilds/$(guildId)).data.ownerId;
      }

      match /events/{eventId} {
        allow read: if isGuildMember(guildId);
        allow create: if hasGuildPermission(guildId, "MANAGE_EVENTS_CREATE");
        allow update: if hasGuildPermission(guildId, "MANAGE_EVENTS_EDIT") || isGuildMember(guildId); // Member can update for RSVP
        allow delete: if hasGuildPermission(guildId, "MANAGE_EVENTS_DELETE");

        match /manualConfirmations/{userId} {
          allow read: if request.auth.uid == userId || hasGuildPermission(guildId, "MANAGE_MANUAL_CONFIRMATIONS_APPROVE");
          allow create: if request.auth.uid == userId && request.resource.data.userId == userId;
          allow update: if hasGuildPermission(guildId, "MANAGE_MANUAL_CONFIRMATIONS_APPROVE");
          allow delete: if request.auth.uid == get(/databases/$(database)/documents/guilds/$(guildId)).data.ownerId;
        }
      }

      match /groups/{groupId} {
        allow read: if isGuildMember(guildId);
        allow create: if hasGuildPermission(guildId, "MANAGE_GROUPS_CREATE");
        allow update: if hasGuildPermission(guildId, "MANAGE_GROUPS_EDIT");
        allow delete: if hasGuildPermission(guildId, "MANAGE_GROUPS_DELETE");
      }

      match /notifications/{notificationId} {
        allow read: if isGuildMember(guildId);
        allow create, update: if isGuildAdminEquivalent(guildId);
        allow delete: if request.auth.uid == get(/databases/$(database)/documents/guilds/$(guildId)).data.ownerId;
      }

      match /dkpDecayLogs/{logId} {
         allow read: if hasGuildPermission(guildId, "MANAGE_DKP_DECAY_SETTINGS");
         allow create: if isGuildAdminEquivalent(guildId);
         allow delete: if request.auth.uid == get(/databases/$(database)/documents/guilds/$(guildId)).data.ownerId;
      }
      
      match /bankItems/{itemId} {
        allow read: if isGuildMember(guildId);
        allow create: if hasGuildPermission(guildId, "MANAGE_LOOT_BANK_ADD");
        allow update: if hasGuildPermission(guildId, "MANAGE_LOOT_BANK_MANAGE");
        allow delete: if hasGuildPermission(guildId, "MANAGE_LOOT_BANK_MANAGE");
      }

      match /auctions/{auctionId} {
        allow read: if isGuildMember(guildId);
        allow create: if hasGuildPermission(guildId, "MANAGE_LOOT_AUCTIONS_CREATE");
        allow update: if hasGuildPermission(guildId, "MANAGE_LOOT_AUCTIONS_EDIT") || isGuildMember(guildId);
        allow delete: if hasGuildPermission(guildId, "MANAGE_LOOT_AUCTIONS_DELETE");
      }

      match /rolls/{rollId} {
        allow read: if isGuildMember(guildId);
        allow create: if hasGuildPermission(guildId, "MANAGE_LOOT_ROLLS_CREATE");
        allow update: if hasGuildPermission(guildId, "MANAGE_LOOT_ROLLS_MANAGE");
        allow delete: if hasGuildPermission(guildId, "MANAGE_LOOT_SETTINGS");
      }
    }
  }
}
